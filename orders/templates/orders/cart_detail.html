{% extends "base.html" %}
{% block content %}
<h2 class="cart-title">Корзина</h2>

<style>
:root {
    --accent: #ff6a00;
    --accent-soft: rgba(255,106,0,.12);
    --accent-dark: #e55f00;
    --bg-page: #fafafa;
    --bg-card: #ffffff;
    --text-main: #1f1f1f;
    --text-muted: #777;
    --border-soft: #ececec;
}

/* ===== Заголовок ===== */
.cart-title {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 25px;
}

/* ===== Карточка таблицы ===== */
.cart-card {
    background: var(--bg-card);
    border-radius: 18px;
    box-shadow:
        0 20px 40px rgba(0,0,0,.06),
        inset 0 1px 0 rgba(255,255,255,.6);
    padding: 10px;
}

/* ===== Таблица ===== */
.cart-table {
    margin: 0;
}

.cart-table thead th {
    font-weight: 600;
    color: var(--text-muted);
    border-bottom: none;
    padding: 18px;
}

.cart-table tbody td {
    padding: 18px;
    border-top: 1px solid var(--border-soft);
    font-size: 15px;
}

.cart-table tbody tr:hover {
    background: #fffaf5;
}

/* ===== Название товара ===== */
.cart-product {
    font-weight: 600;
}

/* ===== Количество ===== */
.quantity-controls {
    display: inline-flex;
    align-items: center;
    background: var(--accent-soft);
    padding: 4px;
    border-radius: 999px;
}

.quantity-btn {
    width: 34px;
    height: 34px;
    border: none;
    border-radius: 50%;
    background: white;
    font-size: 18px;
    font-weight: 600;
    color: var(--accent);
    cursor: pointer;
    transition: all .2s ease;
    box-shadow: 0 4px 10px rgba(0,0,0,.08);
}

.quantity-btn:hover {
    background: var(--accent);
    color: white;
    transform: scale(1.1);
}

.quantity-input {
    width: 42px;
    border: none;
    background: transparent;
    font-weight: 600;
    text-align: center;
    color: var(--text-main);
}

/* ===== Цена ===== */
.cart-price {
    font-weight: 600;
}

/* ===== Удаление ===== */
.cart-remove {
    color: #bbb;
    font-size: 20px;
    transition: all .2s ease;
}

.cart-remove:hover {
    color: #ff3b3b;
    transform: rotate(90deg) scale(1.2);
}

/* ===== Итог ===== */
.cart-summary {
    margin-top: 30px;
    padding: 26px 30px;
   
    border-radius: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    
}

.cart-summary span {
    font-size: 18px;
    color: var(--text-muted);
}

.cart-summary strong {
    font-size: 26px;
    color: var(--accent);
}

/* ===== Промокод ===== */
.promo-box {
    margin-top: 35px;
    padding: 25px;
    background: var(--bg-card);
    border-radius: 20px;
    box-shadow: 0 10px 25px rgba(0,0,0,.05);
}

.promo-box h5 {
    font-weight: 700;
    margin-bottom: 15px;
}

.promo-box .form-control {
    border-radius: 999px;
    padding: 12px 18px;
    border: 1px solid var(--border-soft);
}

.promo-box .btn {
    border-radius: 999px;
    padding: 10px 22px;
    border: 2px solid var(--accent);
    color: var(--accent);
    font-weight: 600;
    transition: all .2s ease;
}

.promo-box .btn:hover {
    background: var(--accent);
    color: white;
}

/* ===== Кнопка ===== */
.checkout-btn {
    margin-top: 40px;
    display: inline-block;
    padding: 18px 44px;
    background: linear-gradient(
        135deg,
        #ff6a00,
        #ff8c1a
    );
    color: white;
    font-size: 20px;
    font-weight: 700;
    border-radius: 999px;
    text-decoration: none;
    box-shadow:
        0 18px 45px rgba(255,106,0,.45);
    transition: all .25s ease;
}

.checkout-btn:hover {
    transform: translateY(-3px) scale(1.03);
    box-shadow: 0 25px 55px rgba(255,106,0,.55);
}

/* ===== Обновление ===== */
.updating {
    opacity: .55;
    pointer-events: none;
}



/* ===== PROMO CARD ===== */
.promo-card {
    margin-top: 35px;
    padding: 26px 28px;
    
    border-radius: 22px;
    
}

/* ===== HEADER ===== */
.promo-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 18px;
}

.promo-header h5 {
    margin: 0;
    font-size: 18px;
    font-weight: 700;
}

.promo-icon {
    font-size: 22px;
}

/* ===== INPUT ===== */
.promo-input-wrap {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.promo-input {
    flex: 1;
    padding: 14px 20px;
    border-radius: 999px;
    border: 1px solid #eee;
    font-size: 15px;
    transition: all .2s ease;
}

.promo-input:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 4px rgba(255,106,0,.15);
}

/* ===== BUTTON ===== */
.promo-btn {
    padding: 14px 28px;
    border-radius: 999px;
    border: none;
    background: linear-gradient(
        135deg,
        #ff6a00,
        #ff8c1a
    );
    color: white;
    font-weight: 700;
    cursor: pointer;
    transition: all .25s ease;
    box-shadow: 0 10px 30px rgba(255,106,0,.45);
}

.promo-btn:hover {
    transform: translateY(-2px) scale(1.04);
    box-shadow: 0 16px 40px rgba(255,106,0,.55);
}

/* ===== MESSAGE ===== */
.promo-message {
    margin-top: 14px;
    font-size: 14px;
}

.promo-message .text-success {
    color: #2e7d32;
}

.promo-message .text-danger {
    color: #d32f2f;
}

/* ===== APPLIED ===== */
.promo-applied {
    margin-top: 18px;
    padding: 14px 18px;
    background: rgba(255,106,0,.1);
    border-radius: 14px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
}

.promo-applied strong {
    color: var(--accent);
}

/* ===== REMOVE ===== */
.promo-remove {
    background: none;
    border: none;
    color: #ff3b3b;
    font-weight: 600;
    cursor: pointer;
    transition: all .2s ease;
}

.promo-remove:hover {
    transform: scale(1.1);
}





















.cart-footer {
    margin-top: 25px;
    padding: 16px;
    background: #fff;
    border-top: 1px solid #eee;
    display: flex;
    flex-wrap: wrap;
    gap: 14px;
    align-items: center;
    justify-content: space-between;
}

.cart-footer__promo {
    display: flex;
    gap: 8px;
    align-items: center;
}

.cart-footer__promo input {
    height: 38px;
    padding: 0 14px;
    border-radius: 999px;
    border: 1px solid #ddd;
}

.cart-footer__promo button {
    height: 38px;
    padding: 0 16px;
    border-radius: 999px;
    border: none;
    background: #ff6a00;
    color: white;
    font-weight: 600;
}

.cart-footer__total {
    font-size: 18px;
    font-weight: 700;
}

.cart-footer__checkout {
    padding: 12px 22px;
    border-radius: 999px;
    background: #ff6a00;
    color: white;
    font-weight: 700;
    text-decoration: none;
}



</style>
<div class="cart-card">
<table class="table cart-table table-hover align-middle">
    <thead>
        <tr>
            <th>Товар</th>
            <th>Цена</th>
            <th>Кол-во</th>
            <th>Итого</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        {% for item in cart %}
        <tr id="item-{{ item.product.id }}">
            <td class="cart-product">{{ item.product.name }}</td>
            <td class="cart-price">{{ item.price }} ₽</td>
            <td>
                <div class="quantity-controls">
                    <button class="quantity-btn" onclick="updateQuantity({{ item.product_id }}, -1)">-</button>
                    <input type="number" class="quantity-input" id="qty-{{ item.product_id }}" 
                           value="{{ item.quantity }}" min="1" max="99" readonly>
                    <button class="quantity-btn" onclick="updateQuantity({{ item.product_id }}, 1)">+</button>
                </div>
            </td>
            <td id="total-{{ item.product.id }}">{{ item.total_price }} ₽</td>
            <td>
                <a href="{% url 'orders:cart_remove' item.product_id %}" class="cart-remove">
                    <svg
  class="icon icon-x"
  viewBox="0 0 24 24"
  width="20"
  height="20"
  aria-hidden="true"
>
  <path
    d="M6 6L18 18M18 6L6 18"
    fill="none"
    stroke="currentColor"
    stroke-width="2.4"
    stroke-linecap="round"
    stroke-linejoin="round"
  />
</svg>

                </a>

            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
</div>


<div class="cart-footer">
    <div class="cart-footer__promo">
        <input type="text" id="promoCode" placeholder="Промокод">
        <button onclick="applyPromoCode()">Применить</button>
        <div id="promoMessage" class="promo-message"></div>
    </div>

    <div class="cart-footer__total">
        <span>Итого:</span>
        <strong id="cart-total-price">{{ total_price }} ₽</strong>
    </div>

    <a href="{% url 'orders:order_create' %}" class="cart-footer__checkout">
        Оформить заказ →
    </a>
</div>




<!--<div class="cart-summary">
    <span>Общая сумма:</span>
    <strong id="cart-total-price">{{ total_price }} ₽</strong>
</div>



<div class="promo-card">
    <div class="promo-header">
        
        <h5>Промокод</h5>
    </div>

    <div class="promo-input-wrap">
        <input 
            type="text"
            id="promoCode"
            class="promo-input"
            placeholder="Введите промокод"
        >
        <button class="promo-btn" onclick="applyPromoCode()">
            Применить
        </button>
    </div>

    <div id="promoMessage" class="promo-message"></div>

    {% if cart.promo_code %}
    <div class="promo-applied">
        <span>
            ✅ Применён промокод 
            <strong>{{ cart.promo_code.code }}</strong>
            (-{{ cart.promo_code.discount }}%)
        </span>
        <button class="promo-remove" onclick="removePromoCode()">
            Удалить
        </button>
    </div>
    {% endif %}
</div>


<a href="{% url 'orders:order_create' %}" class="checkout-btn">
    Оформить заказ →
</a>
-->
<script>
function updateQuantity(productId, change) {
    console.log('Updating product:', productId, 'change:', change);
    
    const input = document.getElementById('qty-' + productId);
    const currentQty = parseInt(input.value);
    let newQty = currentQty + change;
    
    if (newQty < 1) newQty = 1;
    
    const row = document.getElementById('item-' + productId);
    row.classList.add('updating');
    
    // Используем правильный URL с namespace
    fetch("{% url 'orders:cart_update' 0 %}".replace('0', productId), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: 'quantity=' + newQty
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            input.value = data.quantity;
            document.getElementById('total-' + productId).textContent = data.item_total + ' ₽';
            document.getElementById('cart-total-price').textContent = data.total_price + ' ₽';
        } else {
            console.error('Server error:', data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при обновлении количества');
    })
    .finally(() => {
        row.classList.remove('updating');
    });
}


function applyPromoCode() {
    const code = document.getElementById('promoCode').value;
    const messageDiv = document.getElementById('promoMessage');
    
    if (!code) {
        messageDiv.innerHTML = '<span class="text-danger">Введите промокод</span>';
        return;
    }
    
    fetch("{% url 'orders:apply_promo' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: 'code=' + encodeURIComponent(code)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            
            // ОБНОВЛЯЕМ СУММУ НА СТРАНИЦЕ
            document.getElementById('cart-total-price').textContent = data.new_total.toFixed(2) + ' ₽';
            
            // Показываем информацию о скидке
            const discountInfo = `
                <div class="text-success">
                     Применена скидка ${data.discount}% 
                    (Экономия: ${(data.original_total - data.new_total).toFixed(2)} ₽)
                </div>
            `;
            messageDiv.innerHTML += discountInfo;
            
        } else {
            messageDiv.innerHTML = '<span class="text-danger">' + data.message + '</span>';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        messageDiv.innerHTML = '<span class="text-danger">Ошибка при применении промокода</span>';
    });
}
function removePromoCode() {
    fetch("{% url 'orders:remove_promo' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('cart-total-price').textContent = data.new_total.toFixed(2) + ' ₽';
            location.reload();
        }
    });
}
</script>

{% endblock %}