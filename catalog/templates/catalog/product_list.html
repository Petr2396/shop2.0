{% extends "base.html" %}
{% block title %}–ö–∞—Ç–∞–ª–æ–≥{% endblock %}
{% block content %}

<style>
/* ===== scoped ===== */
.mp-cat{
  --brand:#ff6a00;
  --text:#111827;
  --muted:#6b7280;
  --line:#e5e7eb;
}

.mp-cat, .mp-cat *{
  font-weight: 400; /* –±–∞–∑–∞ ‚Äî –±–µ–∑ –∂–∏—Ä–Ω—è–∫–∞ */
}

/* Top */
.mp-cat .topbar{
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  gap: 12px;
  margin: 6px 0 14px;
  flex-wrap: wrap;
}
.mp-cat .title{
  margin: 0;
  font-size: 22px;
  color: var(--text);
  font-weight: 600; /* –∞–∫–∫—É—Ä–∞—Ç–Ω–æ */
  letter-spacing: -.2px;
}
.mp-cat .subtitle{
  margin: 2px 0 0;
  color: var(--muted);
  font-size: 13px;
}
.mp-cat .subtitle b{ font-weight: 500; } /* —Ç–æ–ª—å–∫–æ –ª–µ–≥–∫–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ */

/* Search */
.mp-cat .search{
  display:flex;
  gap: 10px;
  border: 1px solid var(--line);
  border-radius: 999px;
  padding: 8px;
  background: #fff;
  min-width: min(520px, 100%);
  box-shadow: 0 2px 10px rgba(0,0,0,.04);
}
.mp-cat .search input{
  border:0;
  outline:0;
  flex:1;
  padding: 8px 10px;
  font-size: 14px;
  min-width: 0;
}
.mp-cat .search button{
  border:0;
  background: var(--brand);
  color:#fff;
  border-radius: 999px;
  padding: 9px 12px;    /* –º–µ–Ω—å—à–µ */
  font-weight: 500;     /* –±–µ–∑ –∂–∏—Ä–Ω—è–∫–∞ */
  cursor:pointer;
  transition:.15s;
}
.mp-cat .search button:hover{ filter: brightness(.96); transform: translateY(-1px); }

/* Categories chips */
.mp-cat .cats{
  display:flex;
  flex-wrap:wrap;
  gap: 8px;
  padding: 12px;
  border-radius: 16px;
  border: 1px solid var(--line);
  background: #fff;
  box-shadow: 0 2px 10px rgba(0,0,0,.04);
  margin-bottom: 16px;
}
.mp-cat .chip{
  display:inline-flex;
  align-items:center;
  gap: 8px;
  padding: 7px 11px;
  border-radius: 999px;
  border: 1px solid var(--line);
  background:#fff;
  color: var(--text);
  text-decoration:none;
  font-weight: 500; /* –º—è–≥–∫–æ */
  font-size: 13px;
  transition:.15s;
}
.mp-cat .chip:hover{ transform: translateY(-1px); border-color:#d1d5db; }
.mp-cat .chip .ico{
  width: 28px; height: 28px;
  border-radius: 10px;
  background: rgba(255,106,0,.10);
  display:flex; align-items:center; justify-content:center;
  font-size: 16px;
}
.mp-cat .chip.active{
  border-color: rgba(255,106,0,.40);
  background: rgba(255,106,0,.06);
  box-shadow: 0 10px 18px rgba(255,106,0,.08);
}
.mp-cat .clear{
  margin-left:auto;
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding: 7px 11px;
  border-radius: 999px;
  border: 1px solid rgba(255,106,0,.30);
  background: rgba(255,106,0,.08);
  color: var(--brand);
  text-decoration:none;
  font-weight: 500;
  font-size: 13px;
  transition:.15s;
}
.mp-cat .clear:hover{ transform: translateY(-1px); filter: brightness(.98); }

/* Products grid */
.mp-cat .grid{
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 14px;
}
.mp-cat .mp-card{
  border: 1px solid var(--line);
  border-radius: 16px;
  background: #fff;
  overflow:hidden;
  box-shadow: 0 3px 12px rgba(0,0,0,.06);
  transition: .18s;
  display:flex;
  flex-direction:column;
  min-height: 360px;
}
.mp-cat .mp-card:hover{
  transform: translateY(-3px);
  box-shadow: 0 16px 30px rgba(0,0,0,.10);
  border-color: #d1d5db;
}

.mp-cat .media{
  height: 190px;
  background: #f8fafc;
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
}
.mp-cat .media img{
  width:100%;
  height:100%;
  object-fit: contain;
}
.mp-cat .badge{
  position:absolute;
  top: 12px; left: 12px;
  padding: 5px 9px;
  border-radius: 999px;
  background: #fff;
  border: 1px solid rgba(255,106,0,.22);
  color: var(--brand);
  font-weight: 500;
  font-size: 12px;
}

.mp-cat .body{
  padding: 12px 14px 14px;
  display:flex;
  flex-direction:column;
  gap: 8px;
  flex: 1;
}
.mp-cat .name{
  font-size: 14px;
  font-weight: 500; /* –±—ã–ª–æ 900 */
  color: var(--text);
  line-height: 1.25;
  min-height: 36px;
}
.mp-cat .meta{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 10px;
  color: var(--muted);
  font-size: 12px;
}
.mp-cat .price{
  font-size: 18px;
  font-weight: 600; /* —á—É—Ç—å –≤—ã–¥–µ–ª—è–µ–º —Ü–µ–Ω—É */
  color: var(--text);
  letter-spacing: -.15px;
}
.mp-cat .actions{
  margin-top:auto;
  display:flex;
  align-items:center;
  gap: 10px;
}

.mp-cat .btn-detail{
  flex:1;
  text-align:center;
  text-decoration:none;
  padding: 7px 10px;     /* –º–µ–Ω—å—à–µ */
  border-radius: 999px;
  border: 1px solid var(--line);
  background:#fff;
  color: var(--text);
  font-weight: 500;      /* –±–µ–∑ –∂–∏—Ä–Ω—è–∫–∞ */
  font-size: 13px;
  transition:.15s;
}
.mp-cat .btn-detail:hover{ transform: translateY(-1px); border-color:#d1d5db; }

.mp-cat .btn-cart{
  width: 44px; height: 40px; /* —á—É—Ç—å –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ */
  border:0;
  border-radius: 999px;
  background: var(--brand);
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  transition:.15s;
}
.mp-cat .btn-cart:hover{ transform: translateY(-1px); filter: brightness(.96); }

.mp-cat .stars{ color: var(--brand); font-weight: 500; } /* –±—ã–ª–æ 950 */

.mp-cat .empty{
  text-align:center;
  padding: 40px 0;
  color: var(--muted);
}

/* Modal typography normalization */
.mp-cat .modal-content *{ font-weight: 400; }
.mp-cat .modal-title{ font-weight: 600; }
.mp-cat #qvName{ font-weight: 600; }
.mp-cat #qvPrice{ font-weight: 600; }

/* Mobile tweaks */
@media (max-width: 520px){
  .mp-cat .search{ border-radius: 16px; flex-direction:column; }
  .mp-cat .search button{ width: 100%; }
  .mp-cat .clear{ width:100%; justify-content:center; margin-left:0; }
}




</style>

<div class="mp-cat">

  <div class="topbar">
    <div>
      <h1 class="title">–ö–∞—Ç–∞–ª–æ–≥</h1>
      <div class="subtitle">
        {% if current_category %}
          –ö–∞—Ç–µ–≥–æ—Ä–∏—è: <b>{{ current_category.name }}</b>
        {% elif request.GET.q %}
          –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –∑–∞–ø—Ä–æ—Å—É: <b>‚Äú{{ request.GET.q }}‚Äù</b>
        {% else %}
          –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –Ω–∞–π–¥–∏—Ç–µ —Ç–æ–≤–∞—Ä
        {% endif %}
      </div>
    </div>

    <div class="search">
      <input id="searchInput" type="text" value="{{ request.GET.q }}" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—é‚Ä¶">
      <button type="button" id="searchBtn">–ù–∞–π—Ç–∏</button>
    </div>
  </div>

  <div class="cats">
    {% for cat in categories %}
      <a href="?category={{ cat.slug }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}"
         class="chip {% if current_category and current_category.slug == cat.slug %}active{% endif %}">
        <span class="ico">{% if cat.icon %}{{ cat.icon }}{% else %}üõçÔ∏è{% endif %}</span>
        <span>{{ cat.name }}</span>
      </a>
    {% endfor %}

    {% if current_category or request.GET.q %}
      <a href="{% url 'catalog:product_list' %}" class="clear">‚úï –°–±—Ä–æ—Å–∏—Ç—å</a>
    {% endif %}
  </div>

  <div id="productsContainer">
    <div class="grid">
      {% for product in products %}
        <div class="mp-card">
          <div class="media">
            <span class="badge">–¢–æ–ø</span>
            {% if product.images.first %}
              <img src="{{ product.images.first.image.url }}" alt="{{ product.name }}">
            {% else %}
              <img src="https://via.placeholder.com/300x180.png?text=–ù–µ—Ç+—Ñ–æ—Ç–æ" alt="{{ product.name }}">
            {% endif %}
          </div>

          <div class="body">
            <div class="name">{{ product.name }}</div>

            <div class="meta">
              {% if product.category %}
                <span>{{ product.category.name }}</span>
              {% else %}
                <span>&nbsp;</span>
              {% endif %}

              {% if product.rating_count %}
                <span><span class="stars">‚òÖ</span> {{ product.rating_avg|floatformat:1 }} ({{ product.rating_count }})</span>
              {% else %}
                <span>&nbsp;</span>
              {% endif %}
            </div>

            <div class="price">{{ product.price }} ‚ÇΩ</div>

            <div class="actions">
              <button
  type="button"
  class="btn-detail quick-btn"
  data-slug="{{ product.slug }}"
  data-bs-toggle="modal"
  data-bs-target="#quickViewModal"
>
  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
    <path d="M2 12s4-6 10-6 10 6 10 6-4 6-10 6-10-6-10-6Z"/>
    <circle cx="12" cy="12" r="3"/>
  </svg>
  <span>–ë—ã—Å—Ç—Ä—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä</span>
</button>


              <form method="post" action="{% url 'orders:cart_add' product.id %}" class="js-add-to-cart">
                {% csrf_token %}
                <button class="btn-cart" aria-label="–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É">
  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
    <path d="M6 6h15l-2 8H8L6 6Z" />
    <path d="M6 6 5 3H2" />
    <circle cx="9" cy="20" r="1.5" />
    <circle cx="18" cy="20" r="1.5" />
  </svg>
</button>
              </form>
            </div>

          </div>
        </div>

      {% empty %}
        <div class="empty">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</div>
      {% endfor %}
    </div>
  </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const input = document.getElementById("searchInput");
  const btn = document.getElementById("searchBtn");
  const container = document.getElementById("productsContainer");
  let timer = null;

  function runSearch() {
    const q = input.value.trim();
    const url = new URL(window.location.href);
    const currentCategory = new URLSearchParams(window.location.search).get('category');

    if (q) url.searchParams.set("q", q);
    else url.searchParams.delete("q");

    if (currentCategory) url.searchParams.set("category", currentCategory);

    fetch(url)
      .then(res => res.text())
      .then(html => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");
        container.innerHTML = doc.querySelector("#productsContainer").innerHTML;
      });
  }

  input.addEventListener("input", function () {
    clearTimeout(timer);
    timer = setTimeout(runSearch, 300);
  });

  btn.addEventListener("click", runSearch);

  input.addEventListener("keydown", function(e){
    if (e.key === "Enter") {
      e.preventDefault();
      runSearch();
    }
  });
});

document.addEventListener("DOMContentLoaded", function () {
  const qvTitle = document.getElementById("qvTitle");
  const qvName = document.getElementById("qvName");
  const qvCategory = document.getElementById("qvCategory");
  const qvImage = document.getElementById("qvImage");
  const qvPrice = document.getElementById("qvPrice");
  const qvDesc = document.getElementById("qvDesc");
  const qvRating = document.getElementById("qvRating");
  const qvCartForm = document.getElementById("qvCartForm");
  const qvDetailLink = document.getElementById("qvDetailLink");

  document.addEventListener("click", async (e) => {
    const btn = e.target.closest(".quick-btn");
    if (!btn) return;

    const slug = btn.getAttribute("data-slug");
    if (!slug) return;

    qvTitle.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";
    qvName.textContent = "";
    qvCategory.textContent = "";
    qvPrice.textContent = "";
    qvDesc.textContent = "–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ‚Ä¶";
    qvRating.style.display = "none";
    qvImage.src = "";
    qvCartForm.action = "";
    qvDetailLink.href = "#";

    try {
      const res = await fetch(`/catalog/quick/${slug}/`);
      const data = await res.json();

      qvTitle.textContent = "–ë—ã—Å—Ç—Ä—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä";
      qvName.textContent = data.name || "";
      qvCategory.textContent = data.category ? data.category : "";
      qvPrice.textContent = (data.price || "") + " ‚ÇΩ";
      qvDesc.textContent = (data.description || "").slice(0, 400) + ((data.description || "").length > 400 ? "‚Ä¶" : "");

      if (data.image) {
        qvImage.src = data.image;
        qvImage.alt = data.name || "";
      } else {
        qvImage.alt = "–ù–µ—Ç —Ñ–æ—Ç–æ";
      }

      qvCartForm.action = data.cart_url || "";
      qvDetailLink.href = data.detail_url || "#";

      if (data.rating_count && data.rating_count > 0 && data.rating_avg !== null) {
        qvRating.style.display = "block";
        qvRating.innerHTML = `<span style="color:#ff6a00;">‚òÖ</span> ${data.rating_avg.toFixed(1)} (${data.rating_count})`;
      } else {
        qvRating.style.display = "none";
      }
    } catch (err) {
      qvTitle.textContent = "–û—à–∏–±–∫–∞";
      qvDesc.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–≤–∞—Ä. –û–±–Ω–æ–≤–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞.";
    }
  });
});
</script>

<!-- Quick View Modal (Bootstrap) -->
<div class="modal fade" id="quickViewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" style="border-radius:16px; overflow:hidden;">
      <div class="modal-header">
        <h5 class="modal-title" id="qvTitle">–ë—ã—Å—Ç—Ä—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
      </div>

      <div class="modal-body">
        <div class="row g-3">
          <div class="col-md-6">
            <div style="height:320px;background:#f8fafc;border:1px solid #e5e7eb;border-radius:14px;display:flex;align-items:center;justify-content:center;overflow:hidden;">
              <img id="qvImage" src="" alt="" style="width:100%;height:100%;object-fit:contain;">
            </div>
          </div>

          <div class="col-md-6">
            <div class="text-muted mb-1" id="qvCategory"></div>

            <div class="d-flex align-items-center justify-content-between gap-2">
              <h4 class="mb-1" id="qvName"></h4>
            </div>

            <div class="mb-2" id="qvRating" style="font-size:13px;color:#6b7280; display:none;"></div>

            <div class="mb-3" style="font-size:22px;" id="qvPrice"></div>

            <div class="mb-3" style="color:#374151; font-size:14px; line-height:1.35;" id="qvDesc"></div>

            <form method="post" id="qvCartForm" action="" class="js-add-to-cart">
              {% csrf_token %}
              <button type="submit" class="btn" style="background:#ff6a00;color:#fff;border-radius:999px;padding:9px 12px;font-weight:500;border:0;">
                 –í –∫–æ—Ä–∑–∏–Ω—É
              </button>
              <a id="qvDetailLink" href="#" class="btn btn-outline-secondary ms-2" style="border-radius:999px;padding:9px 12px;font-weight:500;">
                –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Ç–æ–≤–∞—Ä
              </a>
            </form>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

{% endblock %}
