<!-- support/templates/support/admin_chat_detail.html -->
<!DOCTYPE html>
<html>
<head>
    <title>–ß–∞—Ç —Å {{ chat.user.username }}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .chat-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header {
            background: #007bff;
            color: white;
            padding: 20px;
            border-radius: 8px 8px 0 0;
        }
        .messages {
            height: 500px;
            overflow-y: auto;
            padding: 20px;
            background: #f9f9f9;
        }
        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 75%;
            word-wrap: break-word;
        }
        .message.admin {
            background: #4CAF50;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        .message.client {
            background: #e9ecef;
            color: #333;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }
        .form-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #ddd;
            border-radius: 0 0 8px 8px;
        }
        textarea {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            resize: vertical;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            float: right;
        }
        .auto-refresh {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-top: 1px solid #ddd;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="chat-container" data-chat-id="{{ chat.id }}">
        <div class="header">
            <h1>üí¨ –ß–∞—Ç —Å {{ chat.user.username|default:"–ö–ª–∏–µ–Ω—Ç–æ–º" }}</h1>
            <p>ID: #{{ chat.id }} | Email: {{ chat.user.email|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}</p>
            <a href="{% url 'admin_chat_list' %}" style="color: white;">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É —á–∞—Ç–æ–≤</a>
        </div>

        <div class="messages" id="messages">
            {% for message in messages %}
            <!-- –í–ê–ñ–ù–û: data-id –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω, –∏–Ω–∞—á–µ –±—É–¥—É—Ç –¥—É–±–ª–∏ -->
            <div class="message {% if message.is_from_admin %}admin{% else %}client{% endif %}"
                 data-id="{{ message.id }}">
                {{ message.text }}
                <div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">
                    {{ message.created|date:"H:i" }}
                    {% if message.is_from_admin %}üëë{% else %}üë§{% endif %}
                </div>
            </div>
            {% empty %}
            <div style="text-align: center; padding: 40px; color: #666;">
                –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —ç—Ç–æ–º —á–∞—Ç–µ
            </div>
            {% endfor %}
        </div>

        <div class="form-container">
            <form method="post" id="admin-message-form">
                {% csrf_token %}
                <textarea name="text" id="admin-message-text" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç..." required></textarea>
                <button type="submit" id="admin-send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
                <div style="clear: both;"></div>
            </form>
        </div>

        <div class="auto-refresh">
            (–ú–æ–∂–Ω–æ –Ω–µ –Ω–∞–∂–∏–º–∞—Ç—å ‚Äî —á–∞—Ç –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å–∞–º)
            <button onclick="location.reload()" style="margin-left: 10px; padding: 5px 10px; font-size: 14px; background: #6c757d;">
                üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å
            </button>
        </div>
    </div>

<script>
class AdminChat {
    constructor(chatId) {
        this.chatId = String(chatId);
        this.messagesContainer = document.getElementById('messages');
        this.form = document.getElementById('admin-message-form');
        this.textarea = document.getElementById('admin-message-text');
        this.btn = document.getElementById('admin-send-btn');
        this.csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        this.lastMessageId = this.getLastMessageId();
        this.abortController = null;

        console.log('[AdminChat] start chatId=', this.chatId, 'lastMessageId=', this.lastMessageId);
        this.init();
    }

    getLastMessageId() {
        const items = this.messagesContainer.querySelectorAll('.message[data-id]');
        if (!items.length) return 0;
        const last = items[items.length - 1];
        const id = parseInt(last.dataset.id, 10);
        return Number.isFinite(id) ? id : 0;
    }

    init() {
        this.form.addEventListener('submit', (e) => this.handleSend(e));
        this.scrollToBottom();
        this.textarea.focus();
        this.startPolling();
    }

    async handleSend(e) {
        e.preventDefault();
        const text = this.textarea.value.trim();
        if (!text) return;

        const original = this.btn.textContent;
        this.btn.textContent = '‚è≥';
        this.btn.disabled = true;

        try {
            const res = await this.sendMessage(text);
            if (res && res.status === 'ok' && res.message_id) {
                // –ù–µ –¥–æ–±–∞–≤–ª—è–µ–º temp ‚Äî –ø—Ä–æ—Å—Ç–æ –∂–¥—ë–º polling (–æ–Ω –ø—Ä–∏–¥—ë—Ç —Å—Ä–∞–∑—É).
                // –ù–æ —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±—ã–ª–æ –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–º –¥–∞–∂–µ –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è polling:
                this.addMessage(text, true, res.message_id);
                this.lastMessageId = Math.max(this.lastMessageId, res.message_id);
            }
            this.textarea.value = '';

            // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º long-poll (—á—Ç–æ–±—ã ‚Äú–ø–æ–¥—Ö–≤–∞—Ç–∏—Ç—å‚Äù –≤–æ–∑–º–æ–∂–Ω—ã–µ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è)
            this.restartPolling();

        } catch (err) {
            console.error('[AdminChat] send error', err);
            alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
        } finally {
            this.btn.textContent = original;
            this.btn.disabled = false;
        }
    }

    async sendMessage(text) {
        const response = await fetch(window.location.href, {
            method: 'POST',
            headers: {
                'X-CSRFToken': this.csrfToken,
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({ text })
        });

        if (!response.ok) throw new Error('HTTP ' + response.status);
        return response.json();
    }

    startPolling() {
        if (this.abortController) return; // —É–∂–µ –∑–∞–ø—É—â–µ–Ω
        this.abortController = new AbortController();
        this.doLongPoll();
    }

    restartPolling() {
        if (this.abortController) {
            this.abortController.abort();
            this.abortController = null;
        }
        // –Ω–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞, —á—Ç–æ–±—ã –Ω–µ –∑–∞—Ü–∏–∫–ª–∏—Ç—å—Å—è
        setTimeout(() => this.startPolling(), 200);
    }

    async doLongPoll() {
        if (!this.abortController) return;

        const url = `/support/admin/api/chat/${this.chatId}/messages/?last_id=${this.lastMessageId}&wait=true`;

        try {
            const response = await fetch(url, {
                signal: this.abortController.signal,
                cache: 'no-store',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });

            if (!response.ok) throw new Error('HTTP ' + response.status);

            const data = await response.json();
            if (data.status === 'ok' && Array.isArray(data.messages) && data.messages.length) {
                let fromClient = 0;

                for (const msg of data.messages) {
                    if (msg.id > this.lastMessageId) {
                        this.addMessage(msg.text, msg.is_from_admin, msg.id);
                        this.lastMessageId = msg.id;
                        if (!msg.is_from_admin) fromClient++;
                    }
                }

                if (fromClient > 0) {
                    this.playNotificationSound();
                }
            }

            // —Å–ª–µ–¥—É—é—â–∏–π long-poll —Å—Ä–∞–∑—É
            this.doLongPoll();

        } catch (err) {
            if (err.name === 'AbortError') return;
            console.error('[AdminChat] poll error', err);

            // –ø–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ 2 —Å–µ–∫
            setTimeout(() => this.doLongPoll(), 2000);
        }
    }

    addMessage(text, isAdmin, messageId) {
        // –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π (—Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ—Ç–æ–º—É —á—Ç–æ –≤ HTML –µ—Å—Ç—å data-id)
        const existing = this.messagesContainer.querySelector(`.message[data-id="${messageId}"]`);
        if (existing) return;

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isAdmin ? 'admin' : 'client'}`;
        messageDiv.dataset.id = messageId;

        const now = new Date();
        const hh = String(now.getHours()).padStart(2, '0');
        const mm = String(now.getMinutes()).padStart(2, '0');

        messageDiv.innerHTML = `
            ${this.escapeHtml(text)}
            <div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">
                ${hh}:${mm} ${isAdmin ? 'üëë' : 'üë§'}
            </div>
        `;

        this.messagesContainer.appendChild(messageDiv);
        this.scrollToBottom();
    }

    scrollToBottom() {
        setTimeout(() => {
            this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
        }, 50);
    }

    playNotificationSound() {
        try {
            const audio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ');
            audio.volume = 0.3;
            audio.play();
        } catch (e) {}
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
}

document.addEventListener('DOMContentLoaded', () => {
    const chatIdEl = document.querySelector('[data-chat-id]');
    const chatId = chatIdEl ? chatIdEl.dataset.chatId : null;
    if (chatId) window.adminChat = new AdminChat(chatId);
});
</script>
</body>
</html>
